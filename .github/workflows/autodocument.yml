# Docs-Clippy GitHub Action

name: Docs-Clippy Documentation Agent

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  docs-clippy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: docs-clippy/update-readmes

      - name: Fallback to main if branch does not exist
        if: failure() && steps.checkout.outcome == 'failure'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Set up Nix
        uses: cachix/install-nix-action@v25

      - name: Read Docs-Clippy prompt
        id: get_prompt
        run: |
          PROMPT_FILE="homemanager/common/apps/vscode/docs-clippy.chatmode.md"
          echo "prompt<<EOF" >> $GITHUB_ENV
          cat "$PROMPT_FILE" >> $GITHUB_ENV
          echo "\n---\nFor each folder in the repository:\n- Create or update a README-doc.md file.\n- List all files in that folder.\n- For each file, read its contents and generate a concise, accessible summary of what the file does or configures, in the context of the overall repository.\n- Provide a brief, high-level overview of the folder’s purpose, based on the file summaries and the folder’s role in the repository.\n- Use clear, friendly technical writing.\n- If a README-doc.md already exists, update it with the new file listing and improved summaries/overview.\n- Output nothing else." >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV


      - name: Generate folder READMEs
        run: |
          python3 .github/scripts/generate_readmes.py

      - name: List generated README files
        run: |
          find . -name 'readme-doc.md' -exec ls -l {} \;

      - name: Show git status and diff
        run: |
          git status
          git diff

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.AUTODOC }}
          commit-message: "docs: auto-generate readme-doc.md files"
          branch: docs-clippy/update-readmes
          title: "docs: auto-generate readme-doc.md files"
          body: "Automated documentation update for folder READMEs."
          add-paths: '**/readme-doc.md'
