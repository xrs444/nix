# Docs-Clippy GitHub Action

name: Docs-Clippy Documentation Agent

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  docs-clippy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Nix
        uses: cachix/install-nix-action@v25

      - name: Read Docs-Clippy prompt
        id: get_prompt
        run: |
          PROMPT_FILE="homemanager/common/apps/vscode/docs-clippy.chatmode.md"
          echo "prompt<<EOF" >> $GITHUB_ENV
          cat "$PROMPT_FILE" >> $GITHUB_ENV
          echo "\n---\nFor each folder in the repository, create or update a README-doc.md file that lists all files in that folder and provides a brief, accessible overview of what the configuration in that folder does. Use clear, friendly technical writing. If a README-doc.md already exists, update it with a file listing and improved overview. Output nothing else." >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Generate folder READMEs
        run: |
          for dir in $(find . -type d ! -path '*/\.*'); do
            (
              cd "$dir"
              echo "# $(basename "$dir")" > readme-doc.md
              echo "" >> readme-doc.md
              echo "## Files" >> readme-doc.md
              echo "" >> readme-doc.md
              ls -1 | grep -v readme-doc.md >> readme-doc.md
              echo "" >> readme-doc.md
              echo "## Overview" >> readme-doc.md
              echo "This folder contains configuration or code related to $(basename "$dir"). Please update this section with a more detailed description." >> readme-doc.md
            )
          done

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.AUTODOC }}
          commit-message: "docs: auto-generate readme-doc.md files"
          branch: docs-clippy/update-readmes
          title: "docs: auto-generate readme-doc.md files"
          body: "Automated documentation update for folder READMEs."
          add-paths: '**/readme-doc.md'
