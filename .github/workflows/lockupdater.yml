name: Flake Lock Updater

on:
  schedule:
    - cron: '3 14 * * *'
  workflow_dispatch:

jobs:
  check-pending:
    name: Check for Pending Update
    runs-on: ubuntu-latest
    outputs:
      has_pending: ${{ steps.check.outputs.has_pending }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check if flake-lock-update branch has unmerged content
        id: check
        run: |
          if git ls-remote --exit-code origin refs/heads/flake-lock-update 2>/dev/null; then
            git fetch origin flake-lock-update
            if git merge-base --is-ancestor FETCH_HEAD origin/main 2>/dev/null; then
              echo "Branch exists but is already merged — safe to update."
              echo "has_pending=false" >> "$GITHUB_OUTPUT"
            else
              echo "Pending flake-lock-update branch found with unmerged content."
              echo "has_pending=true" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "No pending flake-lock-update branch."
            echo "has_pending=false" >> "$GITHUB_OUTPUT"
          fi

  notify-pending:
    name: Notify Pending Update Blocking
    needs: check-pending
    if: needs.check-pending.outputs.has_pending == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Notify pending update is blocking new update
        run: |
          curl -sf -X POST https://apprise.xrs444.net/notify \
            -H "Content-Type: application/json" \
            -d '{"title":"Flake Update: Blocked","body":"A pending flake-lock-update branch exists with unmerged content. Skipping new flake update — rechecking cache for existing update.","type":"warning"}' || true

  update-lock:
    name: Update Flake Lock
    needs: check-pending
    if: needs.check-pending.outputs.has_pending == 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    outputs:
      changed: ${{ steps.changes.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
      - uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: 'holster'
      - uses: DeterminateSystems/determinate-nix-action@v3

      - name: Update flake.lock
        run: nix flake update

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet flake.lock; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push to branch
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -B flake-lock-update
          git add flake.lock
          git commit -m "chore: update flake.lock"
          git push --force origin flake-lock-update

      - name: Notify no changes
        if: steps.changes.outputs.changed == 'false'
        run: |
          curl -sf -X POST https://apprise.xrs444.net/notify \
            -H "Content-Type: application/json" \
            -d '{"title":"Flake Update: No Changes","body":"No flake.lock changes detected. Skipping build.","type":"info"}' || true

  check-cache:
    name: Check Heavy Package Cache
    needs: [check-pending, update-lock]
    if: >-
      always() &&
      needs.check-pending.result == 'success' &&
      (needs.check-pending.outputs.has_pending == 'true' ||
      (needs.update-lock.result == 'success' && needs.update-lock.outputs.changed == 'true'))
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.check.outputs.ready }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: flake-lock-update
      - uses: DeterminateSystems/determinate-nix-action@v3

      - name: Check if heavy packages need source compilation
        id: check
        run: |
          # xcomm1: firefox-esr, webkitgtk (x2), gst-plugins-rs
          # xsvr1: qemu/libvirt for virtualisation
          # A dry-run lists .drv files for anything that must be compiled from source
          HEAVY_PATTERN="firefox|webkitgtk|gst-plugins-rs|qemu"
          UNCACHED=""

          for host in xcomm1 xsvr1; do
            echo "Running dry-run evaluation for $host..."
            DRY=$(nix build ".#nixosConfigurations.$host.config.system.build.toplevel" \
              --no-link --dry-run 2>&1 || true)
            HOST_UNCACHED=$(echo "$DRY" | grep -E "\.drv$" | grep -iE "$HEAVY_PATTERN" || true)
            if [ -n "$HOST_UNCACHED" ]; then
              echo "Heavy packages not yet cached for $host:"
              echo "$HOST_UNCACHED"
              UNCACHED="${UNCACHED}${HOST_UNCACHED}"$'\n'
            fi
          done

          if [ -n "$UNCACHED" ]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
          else
            echo "All heavy packages available in binary cache."
            echo "ready=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify cache not ready
        if: steps.check.outputs.ready == 'false'
        run: |
          curl -sf -X POST https://apprise.xrs444.net/notify \
            -H "Content-Type: application/json" \
            -d '{"title":"Flake Update: Waiting for Cache","body":"Heavy packages (firefox-esr, webkitgtk, gst-plugins-rs, qemu) not yet on cache.nixos.org. Will retry tomorrow.","type":"warning"}' || true

  build-and-cache:
    name: Build & Cache All Hosts
    needs: [check-pending, update-lock, check-cache]
    if: >-
      always() &&
      needs.check-cache.result == 'success' &&
      needs.check-cache.outputs.ready == 'true'
    runs-on: [self-hosted, nixos, builder]
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: flake-lock-update

      - name: Build and cache all hosts
        id: build
        run: |
          HOSTS=(xsvr1 xsvr2 xsvr3 xcomm1 xlabmgmt xdash1 xhac-radio xlt1-t-vnixos xts1 xts2)
          CACHE_URL="file:///zfs/nixcache/cache"
          FAILED=()
          SUCCEEDED=()

          for host in "${HOSTS[@]}"; do
            echo "::group::Building $host"
            if nix build ".#nixosConfigurations.$host.config.system.build.toplevel" --no-link --max-jobs 4 --cores 4 2>&1; then
              echo "Copying $host to cache..."
              nix copy --to "$CACHE_URL" ".#nixosConfigurations.$host.config.system.build.toplevel" || true
              SUCCEEDED+=("$host")
              echo "$host: SUCCESS"
            else
              FAILED+=("$host")
              echo "$host: FAILED"
            fi
            echo "::endgroup::"
          done

          echo "succeeded=${SUCCEEDED[*]}" >> "$GITHUB_OUTPUT"
          echo "succeeded_count=${#SUCCEEDED[@]}" >> "$GITHUB_OUTPUT"
          echo "failed=${FAILED[*]}" >> "$GITHUB_OUTPUT"
          echo "failed_count=${#FAILED[@]}" >> "$GITHUB_OUTPUT"

          if [ ${#FAILED[@]} -gt 0 ]; then
            echo "::error::Failed hosts: ${FAILED[*]}"
            exit 1
          fi

      - name: Create Pull Request
        if: success()
        uses: peter-evans/create-pull-request@v7
        with:
          branch: flake-lock-update
          title: "chore: update flake.lock"
          body: |
            Automated flake.lock update.

            All ${{ steps.build.outputs.succeeded_count }} hosts built and cached successfully on xsvr1:
            `${{ steps.build.outputs.succeeded }}`
          labels: |
            dependencies
            automated

      - name: Notify build success
        if: success()
        run: |
          curl -sf -X POST https://apprise.xrs444.net/notify \
            -H "Content-Type: application/json" \
            -d "{\"title\":\"Flake Update: Build Complete\",\"body\":\"All ${{ steps.build.outputs.succeeded_count }} hosts built and cached. PR created.\",\"type\":\"success\"}" || true

      - name: Notify build failure
        if: failure()
        run: |
          curl -sf -X POST https://apprise.xrs444.net/notify \
            -H "Content-Type: application/json" \
            -d "{\"title\":\"Flake Update: Build Failed\",\"body\":\"Failed hosts: ${{ steps.build.outputs.failed }}. Check GitHub Actions logs.\",\"type\":\"failure\"}" || true
